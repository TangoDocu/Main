<!-- docs/op/Get_AlarmMessages/README.md -->
# Get_AlarmMessages

> Synchronize (retrieve) any alarm that is generated by the Wabco-Transics solution

## Version info
- V7 is the latest version
- V7 uses a list of strings to filter on the alarmtypes, instead of a list of enum values in previous values
- To get the list of available filters use [Get_AlarmMessageTypes](/op/Get_AlarmMessageTypes)

## Request
\* is mandatory

- [Login block](/op/loginblock.md)*
- AlarmMessageSelection: _AlarmMessageSelection\_V7_
	- VehicleListStrategySelection*: _VehicleListStrategySelection_, the strategy needs to be initialized with a VehicleStrategyList or a TrailerStrategyList to filter either on vehicles or trailers
		- IdentifierVehicle: _array of IdentifierVehicle_
			- Id: _string_
			- IdentifierVehicleType: _enumIdentifierVehicleType_: ID, TRANSICS\_ID, CODE, LICENSE\_PLATE
	- DateStrategySelection: different types are possible
		- _ChangeAfter_
			- Since: _DateTime_
		- _Period_
			- From: _DateTime_
			- Until: _DateTime_
	- AlarmMessageTypes: _array of strings_
		- string: _string_
	- AlarmIds: _array of int64_
		- long: _int64_ 
	- OnlyVisiblePopups: _boolean_

## Response
Derived from result object, contains Errors and Warnings: See [result object](/op/resultobject.md)
- result: _Get_AlarmMessages\_V7_
	- AlarmMessages: _AlarmMessageResult\_V7_
		- AlarmId: _int64_
		- Date: _DateTime_
		- Message: _string_
		- AlarmMessageType: _string_
		- IsTreated: _boolean_
		- Vehicle: _IdentifierVehicleResult\_V2_
			- FormattedName: _string_
			- LicensePlate: _string_
			- ID: _string_
			- TransicsID: _int64_
			- Code: _string_
			- Filter: _string_
		- Trailer: _IdentifierTrailerResult_
			- FormattedName: _string_
			- LicensePlate: _string_
			- ID: _string_
			- TransicsID: _int64_
			- Code: _string_
			- Filter: _string_
		- Driver: _IdentifierPerson\_V2_
			- FormattedName: _string_
			- LastName: _string_
			- FirstName: _string_
			- ID: _string_
			- TransicsID: _int64_
			- Code: _string_
			- Filter: _string_
		- Position: _Position_ 
			- Longitude: _double_
			- Latititude: _double_
		- TripId: TripId of the trip that is currently active
		- PlaceId: PlaceId of the place, normally empty for geofencing alarms
		- AlarmParent: _Object_, this can be a reference to a geofence object
			- GeoFenceResult_v3
				- GeoFenceId: _int64_
				- GeoFenceName: _string_
				- GeoZoneStrategy: two types are possible, _RadiusZone_ or _PolygonZone_
					- RadiusZone
						- Name: _string_
						- DriverAlarmText: _string_
						- GeoZoneTransicsId: _int64_
						- Radius: _int32_
						- Position: _Position_ 
							- Longitude: _double_
							- Latititude: _double_
					- PolygonZone
						- Name: _string_
						- DriverAlarmText: _string_
						- GeoZoneTransicsId: _int64_
						- Positions: _array of Positions\_V2_
							- OrderSequence: _int32_
							- Longitude: _double_
							- Latititude: _double_
		- AlarmVisible: _boolean_
		- DateReceived: _DateTime_
		- DataBaseRegistrationDate: _DateTime_
		- DateBaseRegistrationId: _int64_

## Example code
```csharp
IwsServiceWcf.AlarmMessageSelection_V7 AlarmSel = new IwsServiceWcf.AlarmMessageSelection_V7();

AlarmSel.AlarmMessageTypes = new string[] { "GEOFENCING" };
IwsServiceWcf.Period dateStratPeriod = new IwsServiceWcf.Period();

//check if the last day is not older than 5 days
if(storedAlarmSyncDate > DateTime.UtcNow.AddHours(-120))
{
    //date up to where we have synced
    dateStratPeriod.From = storedAlarmSyncDate; 
    //block of 30 minutes
    dateStratPeriod.Until = responseXml.AlarmSyncDate.AddHours(0.5); 
}
//If older than 5 days, then only start up to 5 days ago.
else
{
    dateStratPeriod.From = DateTime.UtcNow.AddHours(-120); //5 days
    dateStratPeriod.Until = DateTime.UtcNow.AddHours(-119.5); //5 days - 4hours
}
//set the date selection strategy                
AlarmSel.DateStrategySelection = dateStratPeriod;

//Already initialize the changeAfter date strategy for when we are in sync
IwsServiceWcf.ChangedAfter dateStratAfter = new IwsServiceWcf.ChangedAfter();

// Periodically check if the service/thread needs to stop
while (!this.stopping)
{
    try
    {
        IwsServiceWcf.Get_AlarmMessages_V7 AlarmResp = iwsService.Get_AlarmMessages_V7(IWSLogin(), AlarmSel);

        foreach (IwsServiceWcf.AlarmMessageResult_V7 alarm in AlarmResp.AlarmMessages)
        {
            //do something with the alarms
        }

        //Check if we still need to catch up, if yes then in blocks of 30 minutes
        if (AlarmResp.MaximumDBRegistrationDate < DateTime.UtcNow.AddHours(-0.5))
        {
            dateStratPeriod.From = AlarmResp.MaximumDBRegistrationDate;
            dateStratPeriod.Until = AlarmResp.MaximumDBRegistrationDate.AddHours(0.5);
            AlarmSel.DateStrategySelection = dateStratPeriod;
        }
        
        //No we are in sync, so get all new data after the last sync date
        else
        {
            dateStratAfter.Since = AlarmResp.MaximumDBRegistrationDate;
            //Change to the changeAfter strategy
            AlarmSel.DateStrategySelection = dateStratAfter;
            alarmsInited = true;
        }            
    }
    catch (Exception e)
    {
        errorCount++;
        log("Exception: Can be a time-out or a connection hickup (retry attempt " + errorCount + ") : " + e.Message);
        //wait a couple of seconds
        Thread.Sleep(errorCount * 1500);
        //retry one hundred times
        if (errorCount > 100)
            //if more than one hundred consequtive errors, then stop and throw the exception
            throw e;
        }
    }
}
```

## Example xml
**Request**
```XML
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  xmlns:tran="http://transics.org">
   <soapenv:Header/>
   <soapenv:Body>
      <tran:Get_AlarmMessages_V7>
         <tran:Login>
            ...
         </tran:Login>
         <tran:AlarmMessageSelection>
            <tran:DateStrategySelection xsi:type="tran:ChangedAfter">
            	<tran:Since>2019-01-09T08:00:00</tran:Since>
            </tran:DateStrategySelection>
            <tran:AlarmMessageTypes>
               <tran:string>GEOFENCING</tran:string>
            </tran:AlarmMessageTypes>
         </tran:AlarmMessageSelection>
      </tran:Get_AlarmMessages_V7>
   </soapenv:Body>
</soapenv:Envelope>
```

**Response**
```XML
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
   <soap:Body>
      <Get_AlarmMessages_V7Response xmlns="http://transics.org">
         <Get_AlarmMessages_V7Result Executiontime="0.325">
            <Errors/>
            <Warnings>
               <Warning>
                  <WarningCode>WARNING_SELECTION_DATETIME_FOR_CHANGEDAFTER</WarningCode>
                  <WarningCodeExplenation>Selection date time for ChangedAfter.</WarningCodeExplenation>
                  <Field>ChangedAfter</Field>
                  <Value>The period that was selected is from  1/9/2019 8:00:00 AM  to  1/9/2019 9:00:00 AM</Value>
               </Warning>
            </Warnings>
            <AlarmMessages>
               <AlarmMessageResult_V7>
                  <AlarmId>10416412</AlarmId>
                  <Date>2019-01-09T08:43:28</Date>
                  <Message>GeoFencing alert - Entered in City of Kortrijk - Gasstraat, Kortrijk (8500).</Message>
                  <AlarmMessageType>GEOFENCING</AlarmMessageType>
                  <AlarmMessageStatus xsi:nil="true"/>
                  <IsTreated>false</IsTreated>
                  <Vehicle>
                     <ID>KCL_WIN322</ID>
                     <TransicsID>2688</TransicsID>
                     <Code>KCL_WIN322_XXT</Code>
                     <Filter/>
                     <LicensePlate>LIC-NEW</LicensePlate>
                     <FormattedName>LIC-NEW (KCL_WIN322)</FormattedName>
                  </Vehicle>
                  <Driver>
                     <ID>KCLTSTSYNC</ID>
                     <TransicsID>144816</TransicsID>
                     <Code>KCLTSTSYNC_EXT</Code>
                     <Filter/>
                     <LastName>Koen</LastName>
                     <FirstName>Koen</FirstName>
                     <FormattedName>Koen (KCLTSTSYNC)</FormattedName>
                  </Driver>
                  <Position>
                     <Longitude>3.2513</Longitude>
                     <Latitude>50.83</Latitude>
                  </Position>
                  <TripId xsi:nil="true"/>
                  <PlaceId xsi:nil="true"/>
                  <AlarmParent xsi:type="GeoFenceResult_v3">
                     <GeoFenceId>6142</GeoFenceId>
                     <GeoFenceName>City of Kortrijk</GeoFenceName>
                     <GeoZoneStrategy xsi:type="RadiusZone">
                        <Name>Gasstraat, Kortrijk (8500)</Name>
                        <DriverAlarmText/>
                        <GeoZoneTransicsId>7151</GeoZoneTransicsId>
                        <Radius>3000</Radius>
                        <Position>
                           <Longitude>3.25571</Longitude>
                           <Latitude>50.83173</Latitude>
                        </Position>
                     </GeoZoneStrategy>
                  </AlarmParent>
                  <AlarmVisible>true</AlarmVisible>
                  <DateReceived>2019-01-09T08:43:57</DateReceived>
                  <DataBaseRegistrationDate>2019-01-09T09:43:57</DataBaseRegistrationDate>
                  <DataBaseRegistrationId>600342237000</DataBaseRegistrationId>
               </AlarmMessageResult_V7>
            </AlarmMessages>
            <MaximumDBRegistrationDate>2019-01-09T09:00:00</MaximumDBRegistrationDate>
            <MaximumDBRegistrationId>600339600000</MaximumDBRegistrationId>
         </Get_AlarmMessages_V7Result>
      </Get_AlarmMessages_V7Response>
   </soap:Body>
</soap:Envelope>
```